<!DOCTYPE html>
<meta charset="utf-8">
<style>
.node circle {
  fill: #fff;
  stroke: steelblue;
  stroke-width: 1.5px;
}
.node {
  font: 10px sans-serif;
}
.link {
  fill: none;
  stroke: #ccc;
  stroke-width: 1.5px;
}
</style>
<body>
<script src="//d3js.org/d3.v3.min.js"></script>
<script>
/* v1.  
previously: in  mytree_radial_layout_bostock.html
tfound a file that works with csv, but not collapsable 
title: Reingoldâ€“Tilford Tree
src: https://bl.ocks.org/mbostock/4063550, https://bl.ocks.org/mbostock/4339184

mysteps:
1) switched from json to csv, switched csv format from name, parent to source, target
2) added code to convert to treemap
3) updated root element with root = treeData[0]; //flare; 
works

this version: cwith more extensive water hierarchy

next: swith to water with value csv file, display node values by 3 classificaiton colors
*/
var margin = {top: 20, right: 120, bottom: 20, left: 120},
    width = 960 - margin.right - margin.left,
    height = 800 - margin.top - margin.bottom;

var diameter = 1080;
var tree = d3.layout.tree()
    .size([360, diameter / 2 - 120])
    .separation(function(a, b) { return (a.parent == b.parent ? 1 : 2) / a.depth; });
var diagonal = d3.svg.diagonal.radial()
    .projection(function(d) { return [d.y, d.x / 180 * Math.PI]; });
var svg = d3.select("body").append("svg")
    .attr("width", diameter)
    .attr("height", diameter - 150)
  .append("g")
    .attr("transform", "translate(" + diameter / 2 + "," + diameter / 2 + ")");
//d3.json("flare.json", function(error, root) {
//  if (error) throw error;

d3.csv("dynamic_data_water.csv", function(error, water) {
  if (error) throw error;
  // *********** Convert flat data into a nice tree ***************
  // create a name: node map
  var dataMap = water.reduce(function(map, node) {
    map[node.target] = node;
    return map;
    console.log("map", map)
  }, {});

  // create the tree array
  var treeData = [];
  water.forEach(function(node) {
    // add to parent
    var parent = dataMap[node.source];
    if (parent) {
      // create child array if it doesn't exist
      (parent.children || (parent.children = []))
        // add node to child array
        .push(node);
    } else {
      console.log("no parent", parent)
      // parent is null or missing
      treeData.push(node);
    }
  });


  console.log("treedata: ", treeData)

  root = treeData[0]; //flare;
  console.log("root", root)
  root.x0 = height / 2;
  root.y0 = 0;

  var nodes = tree.nodes(root),
      links = tree.links(nodes);
  var link = svg.selectAll(".link")
      .data(links)
    .enter().append("path")
      .attr("class", "link")
      .attr("d", diagonal);
  var node = svg.selectAll(".node")
      .data(nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })
  node.append("circle")
      .attr("r", 4.5)
      .style("fill", function(d){ if(d.value==0) { return "green"} else if(d.value==1) { return "orange"} 
        else if(d.value==2) { return "red"} else {console.log("status: ", d.value);return "lightsteelblue"} });
  node.append("text")
      .attr("dy", ".31em")
      .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
      .attr("transform", function(d) { return d.x < 180 ? "translate(8)" : "rotate(180)translate(-8)"; })
      .text(function(d) { return d.target; });
});
d3.select(self.frameElement).style("height", diameter - 150 + "px");
</script>